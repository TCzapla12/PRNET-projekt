@page "/announcements"
@using grpc_hello_world
@using Grpc.Core
@using System.Threading.Tasks
@using Microsoft.AspNetCore.WebUtilities
@inject grpc_hello_world.AnnouncementService.AnnouncementServiceClient AnnouncementServiceClient
@inject NavigationManager NavigationManager
@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage
@rendermode InteractiveServer

<h3>Search Announcements</h3>

<div>
    <label for="id">Announcement ID:</label>
    <input id="id" @bind="AnnouncementId" placeholder="Enter Announcement ID" />

    <label for="authorId">Author ID:</label>
    <input id="authorId" @bind="AuthorId" placeholder="Enter Author ID" />

    <label for="keeperId">Keeper ID:</label>
    <input id="keeperId" @bind="KeeperId" placeholder="Enter Keeper ID" />

    <button @onclick="GetAnnouncements">Search Announcements</button>
</div>

@if (AnnouncementList != null && AnnouncementList.Any())
{
    <ul>
        @foreach (var announcement in AnnouncementList)
        {
            <li>
                <strong>ID:</strong> @announcement.Id <br />
                <strong>Author:</strong>
                <a href="#" @onclick="() => RedirectToUserView(announcement.AuthorId)">
                    User Info
                </a>
                <br />
                <strong>Keeper:</strong>
                <a href="#" @onclick="() => RedirectToUserView(announcement.KeeperId)">
                    User Info
                </a>
                <br />
                <strong>Description:</strong> @announcement.Description <br />
                <strong>Status:</strong> @announcement.Status <br />
                <hr />
            </li>
        }
    </ul>
}
else
{
    <p>No announcements found.</p>
}

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <p style="color:red;">@ErrorMessage</p>
}

@code {
    private string AnnouncementId { get; set; }
    private string AuthorId { get; set; }
    private string KeeperId { get; set; }
    private List<AnnouncementUpdate> AnnouncementList { get; set; }
    private string ErrorMessage { get; set; }

    private bool IsFirstRender { get; set; } = true;
    private bool IsAuthorized { get; set; } = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // After the first render, access the LocalStorage
            var token = await LocalStorage.GetItemAsync<string>("auth_token");
            IsAuthorized = !string.IsNullOrEmpty(token);

            if (!IsAuthorized)
            {
                NavigationManager.NavigateTo("/login");
            }

            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var queryParams = QueryHelpers.ParseQuery(uri.Query);
            if (queryParams.TryGetValue("announcementId", out var announcementIdValue))
            {
                AnnouncementId = announcementIdValue;
                await GetAnnouncements();
            }

            // Set the first render flag to false
            IsFirstRender = false;

            // Trigger a re-render
            StateHasChanged();
        }
    }

    private async Task GetAnnouncements()
    {
        ErrorMessage = string.Empty;
        AnnouncementList = null;
        AnnouncementGet request = new AnnouncementGet();

        // Set the appropriate search criteria based on user input
        if (!string.IsNullOrEmpty(AnnouncementId))
        {
            request.Id = AnnouncementId;
        }
        else if (!string.IsNullOrEmpty(AuthorId))
        {
            request.AuthorId = AuthorId;
        }
        else if (!string.IsNullOrEmpty(KeeperId))
        {
            request.KeeperId = KeeperId;
        }
        else
        {
            ErrorMessage = "Please enter at least one search criteria (ID, Author ID, or Keeper ID).";
            return;
        }

        try
        {
            // Retrieve token from localStorage
            var token = await LocalStorage.GetItemAsync<string>("auth_token");
            var metadata = new Metadata
            {
                { "Authorization", $"Bearer {token}" }
            };
            // Send request to server
            var response = await AnnouncementServiceClient.GetAnnouncementsAsync(request, metadata);
            AnnouncementList = response.Announcements.ToList();
        }
        catch (Grpc.Core.RpcException ex)
        {
            ErrorMessage = $"Error retrieving announcements: {ex.Status.Detail}";
        }
    }

    private void RedirectToUserView(string userId)
    {
        // Redirect to the Users page with the provided user ID in the search field
        NavigationManager.NavigateTo($"/users?userId={userId}");
    }
}
